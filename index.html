<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniMasterSuite | Data Entry Made Effortless</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .tool-card { transition: transform 0.2s, box-shadow 0.2s; }
        .tool-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .preview-thumb { object-fit: cover; width: 100%; height: 100px; border-radius: 8px; border: 2px solid #e5e7eb; }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col">

    <nav class="bg-white shadow z-50">
        <div class="max-w-7xl mx-auto px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="location.reload()">
                    <span class="text-2xl font-bold text-indigo-600">ANI Master<span class="text-gray-800">Suite</span></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex-grow max-w-7xl mx-auto px-4 py-12 w-full">
        
        <div id="menu-view">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                
                <div>
                    <h2 class="text-gray-500 font-bold tracking-wider text-sm mb-4 uppercase">PDF Tools</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div onclick="loadTool('jpg-to-pdf')" class="tool-card bg-white p-4 rounded-lg shadow cursor-pointer flex items-center space-x-4 border-l-4 border-yellow-500">
                            <div class="bg-yellow-100 p-3 rounded text-yellow-600">üñºÔ∏è</div>
                            <div><h3 class="font-bold">JPG to PDF</h3><p class="text-xs text-gray-400">Combine multiple images</p></div>
                        </div>
                        <div onclick="loadTool('word-to-pdf')" class="tool-card bg-white p-4 rounded-lg shadow cursor-pointer flex items-center space-x-4">
                            <div class="bg-blue-100 p-3 rounded text-blue-600">üìù</div>
                            <div><h3 class="font-bold">WORD to PDF</h3></div>
                        </div>
                        <div onclick="loadTool('pdf-to-jpg')" class="tool-card bg-white p-4 rounded-lg shadow cursor-pointer flex items-center space-x-4">
                            <div class="bg-red-100 p-3 rounded text-red-600">üìÑ</div>
                            <div><h3 class="font-bold">PDF to JPG</h3></div>
                        </div>
                         <div onclick="loadTool('compress-pdf')" class="tool-card bg-white p-4 rounded-lg shadow cursor-pointer flex items-center space-x-4">
                            <div class="bg-teal-100 p-3 rounded text-teal-600">üìâ</div>
                            <div><h3 class="font-bold">Compress PDF</h3><p class="text-xs text-gray-400">Reduce file size</p></div>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-gray-500 font-bold tracking-wider text-sm mb-4 uppercase">Data Tools</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div onclick="loadTool('excel-to-pdf')" class="tool-card bg-white p-4 rounded-lg shadow cursor-pointer flex items-center space-x-4">
                            <div class="bg-green-100 p-3 rounded text-green-600">üìä</div>
                            <div><h3 class="font-bold">EXCEL to PDF</h3></div>
                        </div>
                        <div onclick="loadTool('clean-excel')" class="tool-card bg-white p-4 rounded-lg shadow cursor-pointer flex items-center space-x-4">
                            <div class="bg-indigo-100 p-3 rounded text-indigo-600">üßπ</div>
                            <div><h3 class="font-bold">Clean Excel</h3></div>
                        </div>
                        <div onclick="loadTool('duplicate-remover')" class="tool-card bg-white p-4 rounded-lg shadow cursor-pointer flex items-center space-x-4">
                            <div class="bg-orange-100 p-3 rounded text-orange-600">üìã</div>
                            <div><h3 class="font-bold">Duplicate Remover</h3><p class="text-xs text-gray-400">Safe Clean/Highlight</p></div>
                        </div>
                        <div onclick="loadTool('pdf-image-to-excel')" class="tool-card bg-white p-4 rounded-lg shadow cursor-pointer flex items-center space-x-4">
                            <div class="bg-purple-100 p-3 rounded text-purple-600">üëÅÔ∏è</div>
                            <div><h3 class="font-bold">PDF/Img to Excel</h3></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="workspace-view" class="hidden bg-white rounded-xl shadow-lg border border-gray-100 p-8 text-center max-w-3xl mx-auto mt-8">
            <button onclick="location.reload()" class="text-sm text-indigo-500 hover:underline mb-6 block text-left">‚Üê Back to All Tools</button>
            
            <h1 id="tool-title" class="text-3xl font-bold text-gray-800 mb-2">Tool Name</h1>
            <p id="tool-desc" class="text-gray-500 mb-8">Description</p>

            <div id="drop-area" class="border-2 border-dashed border-indigo-300 rounded-xl bg-indigo-50 p-12 cursor-pointer hover:bg-indigo-100 transition" onclick="document.getElementById('file-input').click()">
                <div class="flex flex-col items-center">
                    <svg class="w-12 h-12 text-indigo-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <span class="text-lg font-semibold text-indigo-900">Click to Add File(s)</span>
                    <span class="text-sm text-indigo-600 mt-1" id="file-formats">Supported formats...</span>
                </div>
                <input type="file" id="file-input" class="hidden" onchange="handleFile(this.files)">
            </div>

            <div id="preview-area" class="hidden mt-8">
                <h3 class="text-gray-700 font-bold mb-4">Selected Images:</h3>
                <div id="preview-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-4 mb-6"></div>
                <button id="start-convert-btn" onclick="startProcessing()" class="bg-indigo-600 text-white px-8 py-3 rounded-lg shadow hover:bg-indigo-700 font-bold transition w-full sm:w-auto">
                    Convert these Images to PDF now
                </button>
            </div>

            <div id="dup-options-area" class="hidden mt-8 text-left bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h4 class="font-bold text-gray-700 mb-4">Duplicate Criteria:</h4>
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="dup-criteria" value="row" checked class="w-4 h-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        <span class="ml-2 text-gray-700 font-medium">Exact Row Match (Safe)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="dup-criteria" value="col1" class="w-4 h-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        <span class="ml-2 text-gray-700 font-medium">First Column Only</span>
                    </label>
                </div>
                <div class="flex gap-4">
                    <button onclick="processDuplicateData('highlight')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded transition flex justify-center items-center gap-2">
                        <i class="fas fa-highlighter"></i> Highlight Duplicates
                    </button>
                    <button onclick="processDuplicateData('remove')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition flex justify-center items-center gap-2">
                        <i class="fas fa-trash"></i> Remove Rows
                    </button>
                </div>
            </div>

            <div id="status-area" class="mt-8 hidden">
                <div id="loading-spinner" class="hidden flex justify-center items-center mb-4">
                    <div class="loader"></div><span class="ml-3 text-indigo-600 font-medium">Processing...</span>
                </div>
                <div id="success-msg" class="hidden">
                    <p class="text-green-600 font-bold text-lg mb-4">üéâ Process Complete!</p>
                    <button id="download-btn" class="bg-indigo-600 text-white px-8 py-3 rounded-lg shadow hover:bg-indigo-700 font-bold transition">Download Result</button>
                </div>
                <p id="error-msg" class="text-red-500 mt-4 hidden"></p>
            </div>
        </div>
    </div>

    <script>
        let currentTool = null;
        let globalFileList = []; // For JPG to PDF
        
        // DUPLICATE REMOVER VARIABLES
        let rawDupData = [];
        let activeDupFileName = "";

        // --- TOOLS CONFIGURATION ---
        const tools = {
            'jpg-to-pdf': { id: 'jpg-to-pdf', title: "JPG to PDF", desc: "Add multiple images to combine into a single PDF.", accept: "image/jpeg, image/png, image/jpg", handler: convertJpgToPdf, multiple: true },
            'word-to-pdf': { id: 'word-to-pdf', title: "Word to PDF", desc: "Convert DOCX to PDF.", accept: ".docx", handler: convertWordToPdf },
            'excel-to-pdf': { id: 'excel-to-pdf', title: "Excel to PDF", desc: "Convert Sheets to PDF.", accept: ".xlsx, .xls", handler: convertExcelToPdf },
            'pdf-to-jpg': { id: 'pdf-to-jpg', title: "PDF to JPG", desc: "Extract pages as images.", accept: ".pdf", handler: convertPdfToJpg },
            'compress-pdf': { id: 'compress-pdf', title: "Compress PDF", desc: "Reduce file size without losing readability.", accept: ".pdf", handler: compressPDF },
            'pdf-image-to-excel': { id: 'pdf-image-to-excel', title: "PDF/Image to Excel", desc: "Extract data to Excel.", accept: ".pdf, image/*", handler: convertPdfImageToExcel },
            'clean-excel': { id: 'clean-excel', title: "Clean Excel Sheet", desc: "Remove accents and special symbols.", accept: ".xlsx, .csv", handler: cleanExcelFile },
            'duplicate-remover': { id: 'duplicate-remover', title: "Safe Duplicate Remover", desc: "Highlight or Remove duplicate rows safely.", accept: ".xlsx, .xls, .csv", handler: null }
        };

        function loadTool(id) {
            currentTool = tools[id];
            if(!currentTool) return;
            
            globalFileList = [];

            document.getElementById('menu-view').classList.add('hidden');
            document.getElementById('workspace-view').classList.remove('hidden');
            document.getElementById('tool-title').innerText = currentTool.title;
            document.getElementById('tool-desc').innerText = currentTool.desc;
            document.getElementById('file-formats').innerText = "Supports: " + currentTool.accept;
            
            const fileInput = document.getElementById('file-input');
            fileInput.accept = currentTool.accept;

            if (currentTool.multiple) {
                fileInput.setAttribute('multiple', '');
                document.querySelector('#drop-area span.text-lg').innerText = "Click to Add File(s)";
            } else {
                fileInput.removeAttribute('multiple');
                document.querySelector('#drop-area span.text-lg').innerText = "Click to Choose File";
            }

            resetUI();
        }

        function resetUI() {
            document.getElementById('status-area').classList.add('hidden');
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('success-msg').classList.add('hidden');
            document.getElementById('error-msg').classList.add('hidden');
            document.getElementById('drop-area').classList.remove('hidden');
            document.getElementById('preview-area').classList.add('hidden');
            document.getElementById('dup-options-area').classList.add('hidden');
            document.getElementById('preview-grid').innerHTML = '';
            document.getElementById('file-input').value = '';
        }

        // --- FILE HANDLER ---
        async function handleFile(files) {
            if (files.length === 0) return;

            // 1. JPG TO PDF STAGING
            if (currentTool.id === 'jpg-to-pdf') {
                globalFileList = [...globalFileList, ...Array.from(files)];
                updatePreviewUI();
                return;
            }

            // 2. DUPLICATE REMOVER SPECIAL HANDLING
            if (currentTool.id === 'duplicate-remover') {
                handleDuplicateFile(files[0]);
                return;
            }

            // 3. STANDARD TOOLS (Immediate Processing)
            startProcessingImplementation(files);
        }

        function updatePreviewUI() {
            const previewArea = document.getElementById('preview-area');
            const previewGrid = document.getElementById('preview-grid');
            if (globalFileList.length > 0) {
                previewArea.classList.remove('hidden');
                previewGrid.innerHTML = '';
                globalFileList.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        img.className = 'preview-thumb shadow-sm';
                        previewGrid.appendChild(img);
                    }
                });
            }
        }

        async function startProcessing() {
             if (globalFileList.length === 0) {
                 alert("Please add at least one image.");
                 return;
             }
             document.getElementById('preview-area').classList.add('hidden');
             startProcessingImplementation(globalFileList);
        }

        async function startProcessingImplementation(filesToProcess) {
            document.getElementById('drop-area').classList.add('hidden');
            document.getElementById('status-area').classList.remove('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');

            try {
                await currentTool.handler(filesToProcess);
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('success-msg').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('error-msg').innerText = "Error: " + err.message;
                document.getElementById('error-msg').classList.remove('hidden');
                document.getElementById('drop-area').classList.remove('hidden');
            }
        }

        // ==========================================
        //    FIXED: COMPRESS PDF LOGIC
        // ==========================================
        async function compressPDF(files) {
            const file = files[0];
            const data = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(data).promise;
            
            // Create a new jsPDF instance
            const doc = new window.jspdf.jsPDF();
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                
                // Get page dimensions at 1.0 scale
                const viewport = page.getViewport({ scale: 1.0 });
                const width = viewport.width;
                const height = viewport.height;
                
                // Render page to canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = width;
                canvas.height = height;
                
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                
                // Convert to JPEG with 0.7 quality (Balanced compression)
                const imgData = canvas.toDataURL('image/jpeg', 0.7);
                
                // If it's the first page, we use the default page. 
                // For subsequent pages, we add a new page.
                if (i > 1) {
                    doc.addPage([width, height]);
                } else {
                    // Set first page size to match original PDF page
                    doc.internal.pageSize.width = width;
                    doc.internal.pageSize.height = height;
                }
                
                // Add the compressed image to the PDF
                doc.addImage(imgData, 'JPEG', 0, 0, width, height);
            }
            
            setupDownload(doc.output('blob'), "compressed.pdf");
        }

        // ==========================================
        //    DUPLICATE REMOVER LOGIC
        // ==========================================
        function handleDuplicateFile(file) {
            activeDupFileName = file.name.split('.')[0];
            const reader = new FileReader();
            
            document.getElementById('drop-area').classList.add('hidden');
            document.getElementById('status-area').classList.remove('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');

            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheet];
                
                rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                document.getElementById('loading-spinner').classList.add('hidden');
                
                if(rawData.length > 0) {
                    document.getElementById('dup-options-area').classList.remove('hidden');
                } else {
                    document.getElementById('error-msg').innerText = "File is empty.";
                    document.getElementById('error-msg').classList.remove('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processDuplicateData(mode) {
            if(!rawData || rawData.length === 0) return;

            const criteria = document.querySelector('input[name="dup-criteria"]:checked').value;
            const seen = new Set();
            const duplicatesMap = new Map();

            // Identify
            rawData.forEach((row, index) => {
                let fingerprint = "";
                if (criteria === 'col1') {
                    fingerprint = row[0] ? String(row[0]).trim().toLowerCase() : ""; 
                } else {
                    fingerprint = JSON.stringify(row);
                }
                if (fingerprint === "") return; 
                if (seen.has(fingerprint)) duplicatesMap.set(index, true);
                else seen.add(fingerprint);
            });

            // Rebuild
            const finalRows = [];
            rawData.forEach((row, index) => {
                const isDuplicate = duplicatesMap.has(index);

                if (mode === 'remove') {
                    if (!isDuplicate) finalRows.push(row);
                } else {
                    const styledRow = row.map(cellValue => {
                        let cellObj = { v: cellValue, t: 's' };
                        if(typeof cellValue === 'number') cellObj.t = 'n';
                        if (isDuplicate) {
                            cellObj.s = { fill: { fgColor: { rgb: "FFFF00" } }, font: { color: { rgb: "DC2626" }, bold: true } };
                        }
                        return cellObj;
                    });
                    finalRows.push(styledRow);
                }
            });

            // Download
            const ws = XLSX.utils.aoa_to_sheet(finalRows);
            const colWidths = finalRows[0] ? finalRows[0].map(() => ({ wch: 25 })) : [];
            ws['!cols'] = colWidths;
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Processed_Data");
            const suffix = mode === 'remove' ? "_Cleaned" : "_Highlighted";
            XLSX.writeFile(wb, `${activeDupFileName}${suffix}.xlsx`);

            document.getElementById('dup-options-area').classList.add('hidden');
            document.getElementById('success-msg').classList.remove('hidden');
            document.getElementById('download-btn').style.display = 'none';
        }

        // ==========================================
        //    OTHER TOOLS
        // ==========================================
        async function convertJpgToPdf(files) {
            const doc = new window.jspdf.jsPDF();
            let processedCount = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.startsWith('image/')) continue;
                const imageData = await readImageDimensions(file);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                const ratio = Math.min(pdfWidth / imageData.width, pdfHeight / imageData.height);
                const imgWidth = imageData.width * ratio;
                const imgHeight = imageData.height * ratio;
                const x = (pdfWidth - imgWidth) / 2;
                const y = (pdfHeight - imgHeight) / 2;
                if (processedCount > 0) doc.addPage();
                doc.addImage(imageData.img, 'JPEG', x, y, imgWidth, imgHeight);
                processedCount++;
            }
            if (processedCount === 0) throw new Error("No valid images selected.");
            setupDownload(doc.output('blob'), "combined-images.pdf");
        }

        function readImageDimensions(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => resolve({ img, width: img.width, height: img.height });
                    img.onerror = reject;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function cleanExcelFile(files) {
            const file = files[0];
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                if(!sheet['!ref']) return;
                const range = XLSX.utils.decode_range(sheet['!ref']);
                for(let R = range.s.r; R <= range.e.r; ++R) {
                    for(let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({r:R, c:C});
                        const cell = sheet[cellAddress];
                        if(cell && cell.t === 's') { cell.v = cleanString(cell.v); }
                    }
                }
            });
            XLSX.writeFile(workbook, "Cleaned_" + file.name);
        }

        function cleanString(str) {
            if (!str) return str;
            let cleaned = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            cleaned = cleaned.replace(/‚Äì/g, "-").replace(/‚Äî/g, "-").replace(/[^\x00-\x7F]/g, "");
            return cleaned;
        }
        
        async function convertWordToPdf(files) {
            const file = files[0];
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
            const pdfBlob = await html2pdf().from(result.value).output('blob');
            setupDownload(pdfBlob, "converted.pdf");
        }

        async function convertExcelToPdf(files) {
            const file = files[0];
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const htmlTable = XLSX.utils.sheet_to_html(firstSheet);
            const pdfBlob = await html2pdf().from(htmlTable).output('blob');
            setupDownload(pdfBlob, "converted.pdf");
        }

        async function convertPdfToJpg(files) {
            const file = files[0];
            const data = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(data).promise;
            const zip = new JSZip();
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                zip.file(`page-${i}.jpg`, canvas.toDataURL('image/jpeg').split(',')[1], {base64: true});
            }
            setupDownload(await zip.generateAsync({type:"blob"}), "pages.zip");
        }

        async function convertPdfImageToExcel(files) {
            const file = files[0];
            let extractedText = "";
            if (file.type === "application/pdf") {
                const data = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(data).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    extractedText += textContent.items.map(i => i.str).join(' ') + "\n";
                }
            } else if (file.type.startsWith("image/")) {
                const worker = Tesseract.createWorker();
                await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
                const { data: { text } } = await worker.recognize(file);
                extractedText = text;
                await worker.terminate();
            }
            const rows = extractedText.split('\n').map(line => [line]);
            const worksheet = XLSX.utils.aoa_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
            XLSX.writeFile(workbook, "extracted_data.xlsx");
        }

        function setupDownload(blob, filename) {
            const btn = document.getElementById('download-btn');
            document.getElementById('download-btn').style.display = 'inline-block';
            btn.onclick = () => saveAs(blob, filename);
        }
    </script>
</body>
</html>